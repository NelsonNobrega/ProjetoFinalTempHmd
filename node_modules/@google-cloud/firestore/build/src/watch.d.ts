/*!
 * Copyright 2017 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import * as firestore from '@google-cloud/firestore';
import { google } from '../protos/firestore_v1_proto_api';
import { QueryDocumentSnapshot } from './document';
import { DocumentChange } from './document-change';
import { DocumentReference, Firestore, Query } from './index';
import { Timestamp } from './timestamp';
import api = google.firestore.v1;
/*!
 * Idle timeout used to detect Watch streams that stall (see
 * https://github.com/googleapis/nodejs-firestore/issues/1057, b/156308554).
 * Under normal load, the Watch backend will send a TARGET_CHANGE message
 * roughly every 30 seconds. As discussed with the backend team, we reset the
 * Watch stream if we do not receive any message within 120 seconds.
 */
export declare const WATCH_IDLE_TIMEOUT_MS: number;
/**
 * @private
 * @internal
 * @callback docsCallback
 * @returns {Array.<QueryDocumentSnapshot>} An ordered list of documents.
 */
/**
 * @private
 * @internal
 * @callback changeCallback
 * @returns {Array.<DocumentChange>} An ordered list of document
 * changes.
 */
/**
 * onSnapshot() callback that receives the updated query state.
 *
 * @private
 * @internal
 * @callback watchSnapshotCallback
 *
 * @param {Timestamp} readTime The time at which this snapshot was obtained.
 * @param {number} size The number of documents in the result set.
 * @param {docsCallback} docs A callback that returns the ordered list of
 * documents stored in this snapshot.
 * @param {changeCallback} changes A callback that returns the list of
 * changed documents since the last snapshot delivered for this watch.
 */
type DocumentComparator<AppModelType, DbModelType extends firestore.DocumentData> = (l: QueryDocumentSnapshot<AppModelType, DbModelType>, r: QueryDocumentSnapshot<AppModelType, DbModelType>) => number;
/**
 * Watch provides listen functionality and exposes the 'onSnapshot' observer. It
 * can be used with a valid Firestore Listen target.
 *
 * @class
 * @private
 * @internal
 */
declare abstract class Watch<AppModelType = firestore.DocumentData, DbModelType extends firestore.DocumentData = firestore.DocumentData> {
    readonly _converter: firestore.FirestoreDataConverter<AppModelType, DbModelType>;
    protected readonly firestore: Firestore;
    private readonly backoff;
    private readonly requestTag;
    /**
     * Indicates whether we are interested in data from the stream. Set to false in the
     * 'unsubscribe()' callback.
     * @private
     * @internal
     */
    private isActive;
    /**
     * The current stream to the backend.
     * @private
     * @internal
     */
    private currentStream;
    /**
     * The server assigns and updates the resume token.
     * @private
     * @internal
     */
    private resumeToken;
    /**
     * A map of document names to QueryDocumentSnapshots for the last sent snapshot.
     * @private
     * @internal
     */
    private docMap;
    /**
     * The accumulated map of document changes (keyed by document name) for the
     * current snapshot.
     * @private
     * @internal
     */
    private changeMap;
    /**
     * The current state of the query results. *
     * @private
     * @internal
     */
    private current;
    /**
     * The sorted tree of QueryDocumentSnapshots as sent in the last snapshot.
     * We only look at the keys.
     * @private
     * @internal
     */
    private docTree;
    /**
     * We need this to track whether we've pushed an initial set of changes,
     * since we should push those even when there are no changes, if there
     * aren't docs.
     * @private
     * @internal
     */
    private hasPushed;
    /**
     * The handler used to restart the Watch stream if it has been idle for more
     * than WATCH_IDLE_TIMEOUT_MS.
     */
    private idleTimeoutHandle?;
    private onNext;
    private onError;
    /**
     * @private
     * @internal
     *
     * @param firestore The Firestore Database client.
     */
    constructor(firestore: Firestore, _converter?: firestore.FirestoreDataConverter<AppModelType, DbModelType>);
    /**  Returns a 'Target' proto denoting the target to listen on. */
    protected abstract getTarget(resumeToken?: Uint8Array): api.ITarget;
    /**
     * Returns a comparator for QueryDocumentSnapshots that is used to order the
     * document snapshots returned by this watch.
     */
    protected abstract getComparator(): DocumentComparator<AppModelType, DbModelType>;
    /**
     * Starts a watch and attaches a listener for document change events.
     *
     * @private
     * @internal
     * @param onNext A callback to be called every time a new snapshot is
     * available.
     * @param onError A callback to be called if the listen fails or is cancelled.
     * No further callbacks will occur.
     *
     * @returns An unsubscribe function that can be called to cancel the snapshot
     * listener.
     */
    onSnapshot(onNext: (readTime: Timestamp, size: number, docs: () => Array<QueryDocumentSnapshot<AppModelType, DbModelType>>, changes: () => Array<DocumentChange<AppModelType, DbModelType>>) => void, onError: (error: Error) => void): () => void;
    /**
     * Returns the current count of all documents, including the changes from
     * the current changeMap.
     * @private
     * @internal
     */
    private currentSize;
    /**
     * Splits up document changes into removals, additions, and updates.
     * @private
     * @internal
     */
    private extractCurrentChanges;
    /**
     * Helper to clear the docs on RESET or filter mismatch.
     * @private
     * @internal
     */
    private resetDocs;
    /**
     * Closes the stream and calls onError() if the stream is still active.
     * @private
     * @internal
     */
    private closeStream;
    /**
     * Re-opens the stream unless the specified error is considered permanent.
     * Clears the change map.
     * @private
     * @internal
     */
    private maybeReopenStream;
    /**
     * Cancels the current idle timeout and reschedules a new timer.
     *
     * @private
     * @internal
     */
    private resetIdleTimeout;
    /**
     * Helper to restart the outgoing stream to the backend.
     * @private
     * @internal
     */
    private resetStream;
    /**
     * Initializes a new stream to the backend with backoff.
     * @private
     * @internal
     */
    private initStream;
    /**
     * Handles 'data' events and closes the stream if the response type is
     * invalid.
     * @private
     * @internal
     */
    private onData;
    /**
     * Checks if the current target id is included in the list of target ids.
     * If no targetIds are provided, returns true.
     * @private
     * @internal
     */
    private affectsTarget;
    /**
     * Assembles a new snapshot from the current set of changes and invokes the
     * user's callback. Clears the current changes on completion.
     * @private
     * @internal
     */
    private pushSnapshot;
    /**
     * Applies a document delete to the document tree and the document map.
     * Returns the corresponding DocumentChange event.
     * @private
     * @internal
     */
    private deleteDoc;
    /**
     * Applies a document add to the document tree and the document map. Returns
     * the corresponding DocumentChange event.
     * @private
     * @internal
     */
    private addDoc;
    /**
     * Applies a document modification to the document tree and the document map.
     * Returns the DocumentChange event for successful modifications.
     * @private
     * @internal
     */
    private modifyDoc;
    /**
   ¥#oĞaê#*ë@İåÿzUû–Sõ ’ -Ù$õƒô£ÜQÏ`«sZşÙı™İ¬ğî­BáU=€B@
 -$ÕL€’[¤d¿Ğ2HÊİ ¥é–,ûÉßÙİgô£ì‰$eÿ‘¨Ÿ$OrkBÌÖ„V)-v)ëôjÎ¬f·Ÿ¿X/&üÿ½¥öıôF¤…Š’ê™zmªÓ›u÷`”™ H*Û¶ô=ÛO¿Cœ³÷ÙBDÜˆbfdÄ#Ò @K©U¢L•ßæÜÈ{oD€‘	*3¨ ¬&)é5II¿¬Ú=÷½ÿñLË©mUûêoıd–RıµšÕßÕ·vÔÃ?üÿgªÙş¿CÌ«ƒ(Ç@;—.º’—CéÔØ	;Ä »âƒ.¤0\˜¨÷@òE9¤ çêRymq¥İ¹(İ•öÿùoI51 /4Ë¨NRÛEP/Ò¯êÖî 0I“sÊw‡së‡÷ÕA¿³Zã çGõ @Œy=Ù™ó2`†öûö£O»DFçÄèE•¸ÈŸéîê{öãÂ‡ 0¯ºh†wæO…Ğºú-AşY ÿßé+µO¢wıu¾²Q¸ĞaaÔCR–”mg¶€À9,ü°úÿïûf•‹Lİ=Bk[fq„”f{£øï9ûnÆïÿ_„\ V"‚%H– È™Õ÷œsïû "‚€,FP,¦(ÁÌ¬ÒÖhåÙ­”5¦æ¨œ²ÊjáõÇšf F$¹ü\¯íõèPªÒ°5nÆì¿kšÃvc$äli&‡y#²›œòóûö{µ?;wB3á/ãDOt…ªRÙĞ›NŠ/UÄ¬êk4]á,t¢îÄÎ"ø PHÊ”ÿ´¬ÙÿêHİ„(œØ	¤¾<Ä Ïí:œG„ÅH„p\©šíæq>Ù¹TU‹§iA¡ëpŠ„S†£sŞßÛ*ê@ER¬ü*]Ù¥[ûŸªÿÙ¦1´nŠm[áƒ3+àø	$Ç+‘rxaS,=Ğ‰ÚJßñ½µsg—†^Z¾æ Èıu+”Ù¾¹İ9­¿~ïgE3Á{·=aƒÖ8€kr:KíŠ¯EĞ®o¾³]U_'iÔkŒa/óš_F%ù5Ö¡ˆ.â¿…ªœ(ÀØr3K©öOĞ¸A¨şÿ—jÕ–TfuiŒq»^Îb9İªÕ¿jïVcÿÿ· OÒNJ¤8%*SUşLeµññŞû/šFĞ!@"	 xH¡#Q‚&EyÊqœßÎnßd·œåÀS.¿ÄûÀtÉéCŞ×;fD6ÜØÒ›‘.$´ĞV±UP°“p[’kÎıï2LÃ¥—ôIÒv‹ù^1áîı0ëšôÊt»AÙ»óı±ô_7Û×ÿˆ!„€Ü¢kÑv×°ÙØÆÚïêL…ee?Hô<›xuâşûÓnúœs÷W
B!Iëôİİ2dÖº«ÖéœÿJ)„ )…$ô¼íÎm,kĞø,Öv†„€Èóé¶w¿ïËÔ)é Ié-ù#/ÙŒN‚åƒeèú_ŞxVÏ÷‡$ÊL[z
!ÜRrcÛ÷{™ûï`i<dW’Ii"’;B†š£;ßîƒ[v†“£ÛÈy¼ïj7af€%ø¤ò|Š\ÊÍXG‚ŞûƒÓE©KÂUkå@·‡Ç+¾Ó~¼{'=f¶6á2!=Èoşc˜Õvæï|wmšEc Ğ]ëÇ¾ü?“ìl6û}/£ˆˆˆøµí*äÂDg¶PcêÂŞŞ±Š~qß$	TÉSñ¸Pİ¯ß•ıŸ,³ôKòDDÄ,ë"1“TsŠ}ä2c‘,íNş€2çÿG µĞñ+Éår;v¬òü1×{C€	K[,Y»%Y6¿ùo¹v|¦_N7›ü43@llw·±¬	~uI m«ÖÂ=Yø^Ü\èuP$uû!éİ#ÃQ· Æ\È8ß¯i"3ı±I»å±°!Õ‘ëÃœµ—
££Ëeø¼äÌq['‹zInjÖ‘Õ‘kÿc!ØìRıû¬Jv’MşU;Ò|E@e¼æõÁ?T¿C”mB·ˆyƒ**\œß÷+ísmÓKÒÌô|‘gYP–¯1´ÿ!IlN@Ş/»«"*`’¶I+üû±ôÿOnÓå5]ş¯2 "²¬#"“m˜Öæ.İëæig®Í#„â±ˆÃú1æ~UÙ""áİÓ™óÿ¿½Øe[ÿƒŒ“ädL†€ ¢ÖÄÁ”j
b}ì+ÆS¿—Öms6»µÄq	B²0šù~}Öş’»K&Ùª‹ ""â¤»G™×úSÔOşû²*Iá±“tÅ@×-¿ÆÊ¾ò7³G²Ù©ú£€€\‚W¤Q__c¯ı¤m®ï].ÍLå÷A1à®~]}Ó+–õÿ3nİ˜`gŞ2Ìtº¦ífÇÙØ‘şpî1£ML³‘c¹‰ú®! ‚¤$> ]?Ñºì‘ùjI°ãşå¸wZh!ğLcŸU:c2ÙşîŞaÕùÙ™`2fUÛ„¦{U	¸ƒ}cÿú/éçŸÎ4Š€èDP“¾=·ËØ›ŞÚıÚÛ½ "ßˆØn#˜^ÃÔÿª/NÿÏÕ™ÆâB\B³‹—m¬ªu¾İëg¦ê¦ù|hE[CügLıoÚtüÿ¢ˆˆc@8\îÇÒÿÿ½?í]òÚœÓ°	ˆ¦QdË0s½öç½ä^/mÚ™«|4Æ ò]¶«\cf)_Rg>
ˆ4‘nC–…Š¥êòSı%ƒÒ0.V›»ãñ3Œ‰Äß¶î…K&Œ†v¡=k»¢ƒ/^İ(<âá¨Gí(º©¡O1GHÍŒ©•Ÿ